/*
 * bms_i2c.h
 *
 *  Created on: Jan 12, 2025
 *      Author: Alex
 */

#ifndef INC_BMS_I2C_H_
#define INC_BMS_I2C_H_

#include "main.h"
#include "bms_config.h"


//I2C address of the BMS chip
#define BMS_I2C_ADDR BMS_SET_I2C_ADDR


//I2C direct commands
typedef enum {
  DIRCMD_SAFETY_ALERT_A = 0x02,
  DIRCMD_SAFETY_STATUS_A = 0x03,
  DIRCMD_SAFETY_ALERT_B = 0x04,
  DIRCMD_SAFETY_STATUS_B = 0x05,
  DIRCMD_BATTERY_STATUS = 0x12,
  DIRCMD_CELL1_VOLTAGE = 0x14,
  DIRCMD_CELL2_VOLTAGE = 0x16,
  DIRCMD_CELL3_VOLTAGE = 0x18,
  DIRCMD_CELL4_VOLTAGE = 0x1A,
  DIRCMD_CELL5_VOLTAGE = 0x1C,
  DIRCMD_REG18_VOLTAGE = 0x22,
  DIRCMD_VSS_VOLTAGE = 0x24,
  DIRCMD_STACK_VOLTAGE = 0x26,
  DIRCMD_INT_TEMP = 0x28,
  DIRCMD_TS_MEASUREMENT = 0x2A,
  DIRCMD_RAW_CURRENT = 0x36,
  DIRCMD_CURRENT = 0x3A,
  DIRCMD_CC1_CURRENT = 0x3C,
  DIRCMD_ALARM_STATUS = 0x62,
  DIRCMD_ALARM_RAW_STATUS = 0x64,
  DIRCMD_ALARM_ENABLE = 0x66,
  DIRCMD_FET_CONTROL = 0x68,
  DIRCMD_REGOUT_CONTROL = 0x69,
  DIRCMD_DSGFET_PWM_CONTROL = 0x6A,
  DIRCMD_CHGFET_PWM_CONTROL = 0x6C
} BMS_I2C_DirectCommand;

//I2C subcommands
typedef enum {

} BMS_I2C_SubCommand;

//I2C data memory register addresses
typedef enum {
  REGADDR_CAL_CELL1_GAIN = 0x9000,
  REGADDR_CAL_STACK_GAIN = 0x9002,
  REGADDR_CAL_CELL2_DELTA = 0x9004,
  REGADDR_CAL_CELL3_DELTA = 0x9005,
  REGADDR_CAL_CELL4_DELTA = 0x9071,
  REGADDR_CAL_CELL5_DELTA = 0x9072,
  REGADDR_CAL_CURR_GAIN = 0x9006,
  REGADDR_CAL_CURR_OFFSET = 0x9008,
  REGADDR_CAL_CC1_GAIN = 0x900A,
  REGADDR_CAL_CC1_OFFSET = 0x900C,
  REGADDR_CAL_TS_OFFSET = 0x900E,
  REGADDR_CAL_INT_TEMP_GAIN = 0x9010,
  REGADDR_CAL_INT_TEMP_OFFSET = 0x9012,
  REGADDR_SET_POWER_CONFIG = 0x9014,
  REGADDR_SET_REGOUT_CONFIG = 0x9015,
  REGADDR_SET_I2C_ADDRESS = 0x9016,
  REGADDR_SET_I2C_CONFIG = 0x9017,
  REGADDR_SET_DA_CONFIG = 0x9019,
  REGADDR_SET_VCELL_MODE = 0x901B,
  REGADDR_SET_DEFAULT_ALARM_MASK = 0x901C,
  REGADDR_SET_FET_OPTIONS = 0x901E,
  REGADDR_SET_CHGDET_TIME = 0x901F,
  REGADDR_SET_BAL_CONFIG = 0x9020,
  REGADDR_SET_BAL_MINTEMP = 0x9021,
  REGADDR_SET_BAL_MAXTEMP = 0x9022,
  REGADDR_SET_BAL_MAXTEMP_INT = 0x9023,
  REGADDR_PROT_ENABLE_A = 0x9024,
  REGADDR_PROT_ENABLE_B = 0x9025,
  REGADDR_PROT_DSGFET_A = 0x9026,
  REGADDR_PROT_CHGFET_A = 0x9027,
  REGADDR_PROT_BOTHFET_B = 0x9028,
  REGADDR_PROT_BODYDIODE_THRESHOLD = 0x9029,
  REGADDR_PROT_COW_NORMAL_TIME = 0x902B,
  REGADDR_PROT_COW_SLEEP_CONFIG = 0x902C,
  REGADDR_PROT_HWD_TIMEOUT = 0x902D,
  REGADDR_PROT_CUV_THRESHOLD = 0x902E,
  REGADDR_PROT_CUV_DELAY = 0x9030,
  REGADDR_PROT_CUV_HYSTERESIS = 0x9031,
  REGADDR_PROT_COV_THRESHOLD = 0x9032,
  REGADDR_PROT_COV_DELAY = 0x9034,
  REGADDR_PROT_COV_HYSTERESIS = 0x9035,
  REGADDR_PROT_OCC_THRESHOLD = 0x9036,
  REGADDR_PROT_OCC_DELAY = 0x9037,
  REGADDR_PROT_OCD1_THRESHOLD = 0x9038,
  REGADDR_PROT_OCD1_DELAY = 0x9039,
  REGADDR_PROT_OCD2_THRESHOLD = 0x903A,
  REGADDR_PROT_OCD2_DELAY = 0x903B,
  REGADDR_PROT_SCD_THRESHOLD = 0x903C,
  REGADDR_PROT_SCD_DELAY = 0x903D,
  REGADDR_PROT_CURR_LATCH_LIMIT = 0x903E,
  REGADDR_PROT_CURR_RECOVERY_TIME = 0x903F,
  REGADDR_PROT_OTC_THRESHOLD = 0x9040,
  REGADDR_PROT_OTC_DELAY = 0x9041,
  REGADDR_PROT_OTC_RECOVERY = 0x9042,
  REGADDR_PROT_UTC_THRESHOLD = 0x9043,
  REGADDR_PROT_UTC_DELAY = 0x9044,
  REGADDR_PROT_UTC_RECOVERY = 0x9045,
  REGADDR_PROT_OTD_THRESHOLD = 0x9046,
  REGADDR_PROT_OTD_DELAY = 0x9047,
  REGADDR_PROT_OTD_RECOVERY = 0x9048,
  REGADDR_PROT_UTD_THRESHOLD = 0x9049,
  REGADDR_PROT_UTD_DELAY = 0x904A,
  REGADDR_PROT_UTD_RECOVERY = 0x904B,
  REGADDR_PROT_OTINT_THRESHOLD = 0x904C,
  REGADDR_PROT_OTINT_DELAY = 0x904D,
  REGADDR_PROT_OTINT_RECOVERY = 0x904E,
  REGADDR_PWR_SLEEP_CURRENT = 0x904F,
  REGADDR_PWR_SLEEP_VOLTAGE_TIME = 0x9051,
  REGADDR_PWR_WAKEUP_CURRENT = 0x9052,
  REGADDR_PWR_SHUTDOWN_CELL_VOLTAGE = 0x9053,
  REGADDR_PWR_SHUTDOWN_STACK_VOLTAGE = 0x9055,
  REGADDR_PWR_SHUTDOWN_INT_TEMP = 0x9057,
  REGADDR_PWR_SHUTDOWN_AUTO_TIME = 0x9058,
  REGADDR_PWR_SEC_CONFIG = 0x9059,
  REGADDR_PWR_SEC_FULLACCESS_KEY_1 = 0x905A,
  REGADDR_PWR_SEC_FULLACCESS_KEY_2 = 0x905C
} BMS_I2C_RegAddress;


//sizes of data memory registers in bytes, index = lower byte of address
// _0 _1 _2 _3 _4 _5 _6 _7 _8 _9 _A _B _C _D _E _F
const uint8_t bms_i2c_data_reg_sizes[115] = {
    2, 0, 2, 0, 1, 1, 2, 0, 2, 0, 2, 0, 2, 0, 2, 0, //0_
    2, 0, 2, 0, 1, 1, 1, 2, 0, 2, 0, 1, 2, 0, 1, 1, //1_
    1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 0, 1, 1, 1, 2, 0, //2_
    1, 1, 2, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, //3_
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, //4_
    0, 1, 1, 2, 0, 2, 0, 1, 1, 1, 2, 0, 2, 0, 0, 0, //5_
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, //6_
    0, 1, 1                                         //7_
};


void BMS_I2C_Init();


#endif /* INC_BMS_I2C_H_ */
